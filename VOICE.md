
# Program Configuration

## Terminology 
 - `program` refers to a set of specifications for a synth patch. It starts out in YAML and then turns into a Map when parsed. It's kept as a Map internally. The application looks in two places for them: the resources directory `program` and a directory called `program` (if it exists) relative to the working directory.
 - `voice` when we wish to use those specifications to make noise, the engine turns them into a Voice. Voices are managed by the `ChannelVoicePool` class. The sirens were voices on an island, these are voices in a pool. By creating voices and beforehand and re-using them, we can avoid some of the agony of garbage collection delays. 
 
## Specifications (YAML) 
Below is a basic set of specifications.
 ```
 name: square
 
 osc1:
   midi: note-on   # send this component note ON messages
   detune: -12
   offset: 7 
   type: wave
   shape: square
   out: main
```

## Voice
The properties are as follows:
 - **name** - a label for the `Voice` composed of various components. So you can tell the synth you want this sound. Use the name or a distinct substring with the -all or -ch<n> command-line options to the synth. Alternately, you may use the index of the sound given by the `-list-programs` option. 
 
 - in the future, there will be other properties that can be specified at the voice level.

## Components 
A program can contain multiple components. The above has only one: a square wave generator by the name of `osc1`

What a component will do is defined by a series of properties listed below the name key. The most important is **type**

 - **type** - what type of component this is.  These values are in the `ComponentMaker` switch. Currently, options are:
    - **wave**  - wave generator
    - **env** - envelope generator
    - **mixer** - a junction between voices
    - **limiter** - keeps a signal from overflowing
    - **op-amp** - multiplies two signals together, so that one can control the output envelope of the other. For example an LFO or an Envelope can do amplitude modulation.
    
   More will follow in the future. 
 
  
 - **osc1** - this is the label of the component. It's available for use by any component in the same voice (i.e. this same file).
 Note that the global **main** component (the MainMix object) is declared by default for every voice. If you neglect to put a line `out: main` in some component, the voice has no way of sounding.
 
 - **midi** - tell which type(s) of MIDI message this component should receive. The **MIDI message types** section below lists the eight types.
 
 - **detune** - cents relative to the base frequency. 100 cents equals a half step, so adding detune plus offset you can choose any frequency relative to the base. May be positive or negative.
 
 - **offset** - number of half steps to offset the frequency from the base. -12 is down an octave. 6 is a tritone. Dust off your music theory books! 
 
 - **scale** - output scaling. 1 is unchanged. .5 is half as loud. 2 is twice as loud. The app does not check limits, so be careful! 

 - **shape** - For a wave, the wave form. Envelopes will have a different list, once I get around to implementing them. Following are the key words (which must be exact) for specifying the different wave forms:
    - **sine** - pure sine wave
    - **square** - with 50% duty cycle
    - **pwm** - a square wave with pulse width modulation. In other words, you can hook it up to an LFO to modulate the duty cycle.  
    - **saw** - with a linear rise and a linear fall, with a 50% duty cycle
    - **ramp-up** - a linear rise and instantaneous fall (like a saw with a 100% duty cycle)
    - **ramp-down** - a linear fall and instantaneous rise (a saw with a 0% duty cycle)
    - **harmonic** - allows you to combine sine waves at harmonic intervals. More efficient than the anharmonic WaveGen, because it creates a snapshot of a single cycle at the outset and then plays back from a wavetable. 
    - **anharmonic** - allows you to combine sine waves at whatever intervals you want. Because they are not harmonic, they will have to be computed on the fly.
    - **noise** - a signal generated by the random number function. Note that a WaveGen with this wave shape has no reason to listen to the note frequency. To alter the sound, you'll want a filter.
  
 - **out** - where this component&rsquo;s output is sent to. Here it's going directly to the main out, but it could equally go to a DCA (digitally controlled amplifier) modulated with an envelope generator.
 
 ## other properties 
  - **output-amp** - Sets the output amplitude, overriding other considerations. For sound WaveGens, we scale amplitude (or actually, peak deviation) according to pitch, so that that low frequencies won't get lost, and note-velocity if specified. However, for an LFO we need to control the output level very precisely. It's meant to be paired with the **input-amp** setting on the destination, i.e. both should be the same.
  
  - **input-amp** - The expected maximum amplitude of the input. For a single source, it should be the same as the **output-amp** setting on the source. For multiple sources, you'll have to do some math. The sources are added together.
  
  - **mod-percent** - The percentage of modulation for a PWM wave. See `pwm.yaml` in the resources directory for examples. PWM stands for "Pulse Width Modulation" and refers to changing the duty cycle of a square wave, which gives a kind of combing effect.
  
  - **signed** - When `false` tells the WaveGen to output only values above zero. For an LFO, that's probably what you want. For audible waves, you want **signed** to be `true` 
  
  - **scale** - a multiplier for controlling level on an output. Currently only available on `op-amp` components. 1 means at the same level. .5 for half the volume, 2 for twice the volume.
  
  All signals traveling inside the voice are of type integer, so 32 bits of accuracy. They can be positive or negative.
  
  - **preset** - for a harmonic wave, there are a few presets you can use as an alternative to the **waves** setting that follows. Use one or the other. You can't use both.
  
    Current harmonic wave presets are: 
    - mellow
    - odd
    - bell
    - organ
  
  - **waves** - For the harmonic or anharmonic waves, the composition of the waves is given as a series of integer pairs: 
      - frequency multiplier - we multiply the base frequency by this number to arrive at the frequency of the sine wave you want to add. 
      
      - divisor - we divide the amplitude by this number to get the amplitude of your "harmonic" (or anharmonic as the case may be)

      Note that for harmonic waves, you may specify non-integer values, but since the wave will be a snapshot of the single cycle (and hence harmonic) you will not hear an anharmonic tone, but rather a kind of buzzing. It can yield possibly useful results, so I left it that way.
       
      If you want a genuine anharmonic voice, use the "anharmonic" wave shape. Note that the anharmonic WaveGen is much less efficient than the harmonic one, as it creates all of the waves on the fly. The harmonic WaveGen takes a snapshot of a single wave and uses it as a wavetable. (which is, incidentally, also how a plain sine wave works). 
      
    Here are the settings that the "octave organ" uses (a harmonic WaveGen)   
```
          waves:
            - 1 1
            - 2 2
            - 4 4
            - 8 8
            - 16 16
```
    
 
 ## MIDI message types
 The codes for the MIDI messages are:
 - **note-on** - Note-ON
 - **note-off** - Note-OFF
 - **after** - After-touch
 - **control** - MIDI controllers, including 
    - 0 - bank select MSB
    - 1 - mod wheel
    - 7 - volume
    - 10 - pan
    - 32 - bank select LSB
    - 64 - sustain pedal
 - **program** - program change
 - **pressure** - channel pressure
 - **bend** - pitch bend
 - **system** - system message     
 
Note: the above is almost in numeric order. The first two are swapped, because it bugs me to see Note OFF (0x8) before Note ON (0x9). The rest are sequential. In real life, the ON comes first, right? Even though 0x9 has the 1 bit set and 0x8 doesn't (is that why they swapped them?)

Note also: the reason it's "note-on" instead of just "on" is that YAML insists on converting the word "on" into a boolean. (same is true of a list of other words... on,off,yes,no,true,false, in whatever case).
 
 ## wave shapes
 possible wave shapes at this point are:
 - square 
 - sine
 - saw
 - ramp-up
 - ramp-down
 - harmonic
 - anharmonic
 - pwm

 
 
 --
 
       
    
   
 




